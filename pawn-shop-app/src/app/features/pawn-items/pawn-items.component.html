<div class="pawn-items">
  <div class="pawn-items-header">
    <div class="header-content">
      <h1 class="page-title">üí∞ Pawn Items</h1>
      <p class="page-subtitle">Manage and track all pawned items</p>
    </div>
    <button class="create-btn" (click)="openCreateModal()">
      <span class="btn-icon">+</span>
      Create Item
    </button>
  </div>

  <!-- Filters and Search Section -->
  <div class="filters-section">
    <div class="filter-group">
      <label class="filter-label">Category Filter:</label>
      <div class="category-filters">
        <button 
          *ngFor="let category of categories" 
          class="category-btn"
          [class.active]="selectedCategory === category.value"
          (click)="selectCategory(category.value)"
        >
          <span class="category-icon">{{ category.icon }}</span>
          {{ category.label }}
        </button>
      </div>
    </div>

    <div class="search-group">
      <div class="search-container">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search pawn items..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        >
        <button *ngIf="searchTerm" class="clear-search" (click)="clearSearch()">√ó</button>
      </div>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="stats-overview">
    <div class="stat-item">
      <span class="stat-value">{{ filteredItems.length }}</span>
      <span class="stat-label">Total Items</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ getTotalValue() | currency }}</span>
      <span class="stat-label">Total Value</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ getActiveItems() }}</span>
      <span class="stat-label">Active</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ getExpiredItems() }}</span>
      <span class="stat-label">Expired</span>
    </div>
  </div>

  <!-- Table Section -->
  <div class="table-section">
    <div class="table-header">
      <h3 class="table-title">{{ selectedCategory === 'all' ? 'All Items' : getCategoryLabel(selectedCategory) }}</h3>
      <div class="table-actions">
        <select class="sort-select" [(ngModel)]="sortBy" (change)="onSortChange()">
          <!-- <option value="pawnDate">All</option> -->
          <option value="pawnDate">Sort by Date</option>
          <option value="amount">Sort by Amount</option>
          <option value="customerName">Sort by Customer</option>
          <option value="status">Sort by Status</option>
          <option value="CheckedOutItems">Checked Out Items</option>
        </select>
      </div>
    </div>

    <div class="table-container">
      <table class="pawn-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer Name</th>
            <th>Customer Nrc</th>
            <th>Item Type</th>
            <th *ngFor="let column of getCurrentColumns()">{{ column.label }}</th>
            <th>Amount</th>
            <th>Pawn Date</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredItems; let i = index" class="table-row">
            <td class="id-cell">#{{ item.id }}</td>
            <td class="customer-cell">
              <div class="customer-info">
                <span class="customer-name">{{ item.customerName }}</span>
              </div>
            </td>
            <td class="customer-cell">
              <div class="customer-info">
                <span class="customer-nrc">{{ item.customerNrc }}</span>
              </div>
            </td>
            <td class="category-cell">
              <div class="category-badge">
                <span class="category-icon">{{ getCategoryIcon(item.category) }}</span>
                {{ item.category }}
              </div>
            </td>
            <td *ngFor="let column of getCurrentColumns()" class="dynamic-cell">
              {{ getItemProperty(item, column.key) }}
            </td>
            <td class="amount-cell">{{ item.amount | currency }}</td>
            <td class="date-cell">{{ item.pawnDate | date:'MMM dd, yyyy' }}</td>
            <td class="date-cell">{{ item.dueDate | date:'MMM dd, yyyy' }}</td>
            <td class="status-cell">
              <span class="status-badge" [class]="'status-' + item.status.toLowerCase()">
                {{ item.status }}
              </span>
            </td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button class="action-btn view" (click)="viewItem(item)" title="View Details">üëÅÔ∏è</button>
                <button class="action-btn edit" (click)="editItem(item)" title="Edit Item">‚úèÔ∏è</button>
                <button class="action-btn delete" (click)="deleteItem(item)" title="Delete Item">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div *ngIf="filteredItems.length === 0" class="no-data">
        <div class="no-data-icon">üì¶</div>
        <h3>No items found</h3>
        <p>{{ searchTerm ? 'Try adjusting your search criteria' : 'Start by creating your first pawn item' }}</p>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="filteredItems.length > 0">
    <button class="page-btn" [disabled]="currentPage === 1" (click)="previousPage()">Previous</button>
    <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>
    <button class="page-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">Next</button>
  </div>
</div>

<!-- pawn-item-modal.component.html -->
<!-- Create/Edit Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2> {{ isViewMode ? 'View' : (isEditMode ? 'Edit' : 'Create') }} Pawn Item</h2>
      <button class="close-btn" (click)="closeModal()" [disabled]="isLoading">√ó</button>
    </div>
    
    <form class="modal-form" [formGroup]="pawnForm" (ngSubmit)="savePawnItem()">
      <!-- Customer Information -->
      <div class="form-row">
        <div class="form-group">
          <label for="customerName">Name</label>
          <input 
            id="customerName" 
            type="text" 
            formControlName="customerName"
            [class.error]="pawnForm.get('customerName')?.invalid && pawnForm.get('customerName')?.touched"
            [disabled]="isLoading">
          <div class="error-message" *ngIf="pawnForm.get('customerName')?.invalid && pawnForm.get('customerName')?.touched">
            <span *ngIf="pawnForm.get('customerName')?.errors?.['required']">Name is required</span>
          </div>
        </div>

        <div class="form-group">
          <label for="customerAddress">Address</label>
          <input 
            id="customerAddress" 
            type="text" 
            formControlName="customerAddress"
            [class.error]="pawnForm.get('customerAddress')?.invalid && pawnForm.get('customerAddress')?.touched"
            [disabled]="isLoading">
          <div class="error-message" *ngIf="pawnForm.get('customerAddress')?.invalid && pawnForm.get('customerAddress')?.touched">
            <span *ngIf="pawnForm.get('customerAddress')?.errors?.['required']">Address is required</span>
          </div>
        </div>

        <div class="form-group">
          <label for="customerNrc">NRC</label>
          <input 
            id="customerNrc" 
            type="text" 
            formControlName="customerNrc"
            placeholder="e.g., 12/LAMANA(N)"
            [class.error]="pawnForm.get('customerNrc')?.invalid && pawnForm.get('customerNrc')?.touched"
            [disabled]="isLoading">
          <div class="error-message" *ngIf="pawnForm.get('customerNrc')?.invalid && pawnForm.get('customerNrc')?.touched">
            <span>{{ getNrcErrorMessage() }}</span>
          </div>
        </div>

        <div class="form-group">
          <label for="customerPhone">Phone</label>
          <input 
            id="customerPhone" 
            type="tel" 
            formControlName="customerPhone"
            placeholder="e.g., 09123456789"
            [class.error]="pawnForm.get('customerPhone')?.invalid && pawnForm.get('customerPhone')?.touched"
            [disabled]="isLoading">
          <div class="error-message" *ngIf="pawnForm.get('customerPhone')?.invalid && pawnForm.get('customerPhone')?.touched">
            <span>{{ getPhoneErrorMessage() }}</span>
          </div>
        </div>
      </div>

      <!-- Category and Amount -->
      <div class="form-row">
        <div class="form-group">
          <label for="category">Category</label>
          <select 
            id="category" 
            formControlName="category"
            (change)="onCategoryChange(pawnForm.get('category')?.value)" 
            [class.error]="pawnForm.get('category')?.invalid && pawnForm.get('category')?.touched"
            [disabled]="isLoading">
            <option value="">Select Category</option>
            <option *ngFor="let cat of categories.slice(1)" [value]="cat.value">{{ cat.label }}</option>
          </select>
          <div class="error-message" *ngIf="pawnForm.get('category')?.invalid && pawnForm.get('category')?.touched">
            <span *ngIf="pawnForm.get('category')?.errors?.['required']">Category is required</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="amount">Amount</label>
          <input 
            id="amount" 
            type="number" 
            formControlName="amount"
            min="0" 
            step="0.01" 
            [class.error]="pawnForm.get('amount')?.invalid && pawnForm.get('amount')?.touched"
            [disabled]="isLoading">
          <div class="error-message" *ngIf="pawnForm.get('amount')?.invalid && pawnForm.get('amount')?.touched">
            <span *ngIf="pawnForm.get('amount')?.errors?.['required']">Amount is required</span>
            <span *ngIf="pawnForm.get('amount')?.errors?.['min']">Amount must be greater than 0</span>
          </div>
        </div>
      </div>

      <!-- Dynamic fields based on category -->
      <div class="dynamic-fields" *ngIf="pawnForm.get('category')?.value">
        <h4>{{ getCategoryLabel(pawnForm.get('category')?.value) }} Details</h4>

        <div class="form-row">
          <div class="form-group" *ngFor="let column of getDynamicColumns(pawnForm.get('category')?.value)">
            <label [for]="column.key">
              {{ column.label }}
              <span *ngIf="column.required" class="required-asterisk">*</span>
            </label>

            <!-- Render select if type is 'select' -->
            <select
              *ngIf="column.type === 'select'"
              [id]="column.key"
              [formControlName]="column.key"
              [class.error]="pawnForm.get(column.key)?.invalid && pawnForm.get(column.key)?.touched"
              [disabled]="isLoading">
              <option value="">Select {{ column.label }}</option>
              <option *ngFor="let opt of column.options" [value]="opt">{{ opt }}</option>
            </select>

            <!-- Render input for all other types -->
            <input
              *ngIf="column.type !== 'select'"
              [id]="column.key"
              [type]="column.type || 'text'"
              [formControlName]="column.key"
              [class.error]="pawnForm.get(column.key)?.invalid && pawnForm.get(column.key)?.touched"
              [disabled]="isLoading">

            <!-- Error messages for dynamic fields -->
            <div class="error-message" *ngIf="pawnForm.get(column.key)?.invalid && pawnForm.get(column.key)?.touched">
              <span *ngIf="pawnForm.get(column.key)?.errors?.['required']">{{ column.label }} is required</span>
              <span *ngIf="pawnForm.get(column.key)?.errors?.['min']">{{ column.label }} must be greater than 0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Dates -->
      <div class="form-row">
        <div class="form-group">
          <label for="pawnDate">Pawn Date</label>
          <input 
            id="pawnDate" 
            type="date" 
            formControlName="pawnDate"
            (change)="onPawnDateChange()" 
            [class.error]="pawnForm.get('pawnDate')?.invalid && pawnForm.get('pawnDate')?.touched"
            [disabled]="isLoading">
          <div class="error-message" *ngIf="pawnForm.get('pawnDate')?.invalid && pawnForm.get('pawnDate')?.touched">
            <span *ngIf="pawnForm.get('pawnDate')?.errors?.['required']">Pawn Date is required</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="dueDate">Due Date</label>
          <input 
            id="dueDate" 
            type="date" 
            formControlName="dueDate"
            [class.error]="pawnForm.get('dueDate')?.invalid && pawnForm.get('dueDate')?.touched"
            [disabled]="isLoading">
          <div class="error-message" *ngIf="pawnForm.get('dueDate')?.invalid && pawnForm.get('dueDate')?.touched">
            <span *ngIf="pawnForm.get('dueDate')?.errors?.['required']">Due Date is required</span>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="description">Description (Optional)</label>
        <textarea 
          id="description" 
          formControlName="description"
          rows="3" 
          [disabled]="isLoading">
        </textarea>
      </div>

      <!-- Simple Clean Alert Messages -->
      <div class="alert-container">
        <!-- Success Alert -->
        <div *ngIf="successMessage && !isLoading" class="alert alert-success" [@slideIn]>
          <span class="alert-icon">‚úì</span>
          <div class="alert-text">
            <div class="alert-message">{{ successMessage }}</div>
            <div class="alert-details" *ngIf="responseData">
              Transaction ID: {{ responseData.transactionId }} | Customer ID: {{ responseData.customerId }} | Item ID: {{ responseData.pawnItemId }}
            </div>
          </div>
        </div>

        <!-- Error Alert -->
        <div *ngIf="errorMessage && !isLoading" class="alert alert-error" [@slideIn]>
          <span class="alert-icon">‚úï</span>
          <div class="alert-text">
            <div class="alert-message">{{ errorMessage }}</div>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoading" class="alert alert-loading">
          <div class="loading-spinner"></div>
          <div class="alert-text">
            <div class="alert-message">{{ isEditMode ? 'Updating' : 'Creating' }} pawn item...</div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button 
          type="submit" 
          class="btn-primary" 
          [class.btn-invalid]="!pawnForm.valid"
          [disabled]="!pawnForm.valid || isLoading">
          <span *ngIf="isLoading" class="loading-spinner-small"></span>
          <span *ngIf="!pawnForm.valid && !isLoading" class="invalid-icon">üîí</span>
          {{ isEditMode ? 'Update' : 'Create' }} Item
          <span *ngIf="!pawnForm.valid && !isLoading" class="invalid-text"></span>
        </button>
      </div>
    </form>
  </div>
</div>
